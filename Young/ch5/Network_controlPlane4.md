## 3. 인터넷에서의 AS 내부 라우팅 : OSPF
지금까지 우리는 네트워크를 **단순히 상호 연결된 라우터 집합 덩어리**로 보았다. 모든 라우터가 같은 라우팅 알고리즘을 사용하고, 라우팅 경로를 계산한다는 점에서 그렇다. 그러나, **모든 네트워크를 동종의 라우터 집합**으로 바라보는 것은 2가지 이유로 **지나치게 단순**하다.
- 확장 : 수억 개의 라우터로 구성되어 있는데 하나의 집합으로 볼 경우 모든 라우팅 정보를 저장할 수 없다. 또한, DV 알고리즘을 사용할 경우 **너무 많이 반복되는 알고리즘** 때문에 절대 **수렴하지 않는다.**
- 관리 자율성 : 인터넷의 ISP는 각자 잣니의 라우터들로 네트워크를 관리하고 싶어한다. 

이러한 두 가지 문제는 **라우터들을 자율 시스템(AS)로 조직화하여 해결**한다. 하나의 ISP는 하나의 AS를 가지기도 하고 여러 AS로 구성되기도 한다. AS는 **AS 번호로 식별**되며 ICANN의 지역 등록 기관에 의해 할당된다. 이렇게 AS 내부에서 동작하는 라우팅 알고리즘을 **AS 내부 라우팅 알고리즘**이라고 한다.

#### 개방형 최단 우선(OSPF) 프로토콜
OSPF는 **링크 상태 정보를 플러딩**하는 **다익스트라 최소 비용 경로 알고리즘**을 사용한다. 개별 링크 비용은 네트워크 관리자가 구성한다.(모든 링크 1 설정 또는 링크 용량에 반비례하게 설정)

OSPF를 사용하는 라우터는 **링크 상태가 변경**되거나, **주기적**으로 링크 상태를 **브로드캐스팅**한다. OSPF 메세지(3계층-네트워크)는 인터넷 프로토콜로 보내지는데 상위 계층 프로토콜 번호(IP 헤더의 Protocol 필드)에는 **89**번으로 기록된다. OSPF 프로토콜은 따라서 **신뢰할 수 있는 메세지 전송**과 **링크 상태의 브로드캐스트**와 같은 기능을 스스로 구현해야 한다. 또한, **링크가 동작하고 있는지 검사**하고, OSPF 라우터가 이웃 라우터의 데이터베이스를 얻을 수 있도록 해야 한다.
또한 다음과 같은 기능도 한다.

- **보안** : OSPF 라우터들 간의 정보 교환을 인증하여 신뢰성을 높인다. 두 종류의 인증이 있는데, **단순 인증** 또는 **MD5**를 사용한다. 단순 인증은 **동일한 패스워드가 각 라우터에 설정**된다. 그러나, 라우터가 OSPF 패킷을 보낼 때 패스워드를 **평문**으로 포함하기 때문에 안전하지는 않다. **MD5**인증은 **공유 비밀키**를 기반으로 이루어지기 떄문에 단순인증보다는 안전하다.

- **복수 도일 비용 경로** : 같은 비용을 가지는 여러 경로가 있을 경우 여러 경로를 모두 사용할 수 있다.

- **유니캐스트와 멀티캐스트 라우팅의 통합 지원** : MOSPF는 멀티캐스트 라우팅 기능을 제공하기위해 OSPF를 확장했다.(새로운 형태의 링크 상태 알림 추가)

- **단일 AS 내에서의 계층 지원** : OSPF의 AS는 **계층적인 영역**으로 구ㅂ성될 수 있다. 같은 지역 라우터들끼리만 브로드캐스트하며 하나 또는 여러 개의 **영역 경계라우터**가 영역 외부로의 라우팅을 책임진다. 그리고 AS에서 오직 하나의 OSPF 영역만이 **백본 영역**으로 설정된다. 백본 영역의 주요 역할은 **AS 내 영역 간의 트래픽을 라우팅**하고, **모든 영역 경계 라우터를 포함**하는 것이다. **AS 내 영역 간 라우팅을 위해** 먼저 영역 경계 라우터로 패킷을 라우팅하고(**영역 내**), **백본을 통과해**, **목적지 영역의 영역 경계 라우터로 라우팅**한 후, 최종 목적지로 라우팅한다.

## 4. 인터넷 서비스 제공업자(ISP) 간의 라우팅 : BGP
위의 OSPF는 AS 내의 라우팅 프로토콜 중 하나이다. 그럼 AS 간의 연결은 어떻게 해야 할까?
=> 이때는 **자율 시스템 간 라우팅 프로토콜**이 필요하다. 즉, AS 간 라우팅 프로토콜이 필요하다는 것이다. 실제로 현재는** 경계 게이트웨이 프로토콜(BGP)** 이라고 불리는 프로토콜을 사용한다.

BGP는 수천 개의 ISP를 연결하는 프로토콜고, 거리 벡터 라우팅과 같이 **분산형 비동기식 프로토콜**이다. 

### 4.1 BGP의 역할
BGP 알고리즘은 **목적지가 AS 외부에 있는 경우** 사용된다. 이때 BGP에서는 특정한 목적지 주소가 아니라 **CIDR**형식의 **프리픽스**가 사용된다. - 집합. 따라서 BGP 라우팅 프로토콜에서 포워딩 테이블은 (x-프리픽스, I - 라우터 인터페이스) 형식을 가지게 된다. 
BGP는 아래와 같은 형식을 가지게 해준다.
- **이웃 AS를 통해 도달 가능한 서브넷 프리픽스 정보를 얻는다.** 특히 어떤 서브넷이 자신의 존재를 알리고 연결 가능하도록 만드는 것이다.
- **서브넷 주소 프리픽스로의 가장 좋은 경로를 결정한다.** 출발 라우터에서는 목적지까지 두 가지 이상의 경로를 알 수도 있다. 따라서 **BGP의 결정 프로시저**에 따라 **가장 좋은 경로를 선택**해야 한다.

### 4.2 BGP 경로 정보 알리기
![](https://velog.velcdn.com/images/choiyoung6609/post/271bdf5c-4af5-4b04-88b4-08bd12f298db/image.png)

각각의 라우터에서 **다른 AS와 연결되는 라우터**들을 연결하는 **게이트웨이 라우터**와 **AS 내부에서 경계와 연결되지 않는** **내부 라우터**가 있다. 

3d가 가지고 있는 프리픽스 x에 대한 정보를 모든 라우터에게 알리는 간단한 방법을 생각해보자. 먼저 AS3가 AS2(AS3 x)에게 메세지를 보내고 AS2가 AS1에게 메세지(As2 AS3 x)를 보내면된다. 

위에 문단은 AS 간 메세지를 보내는 방법에 대한 간단한 아이디어를 제공한다. 그러나, 실제로는 **라우터**끼리 메세지를 보내기 때문에 좀 더 복잡하다. 일단 BGP에서 라우터들은 포트 번호 179번을 사용하고 반영구적인 TCP 연결을 사용한다. 이렇게 tcp를 통한 BGP 메세지 전송을 **BGP 연결**이라고 한다. 그리고, 2개의 AS를 연결하는 BGP 연결은 **외부 BGP(eBGP) 연결**이라 하고, 같은 As 간의 BGP연결은 **내부 BGP(iBGP) 연결**이라고 한다. 이떄 iBGP 연결은 물리적인 링크와 항상 일치하지 않을 수 있다.

![](https://velog.velcdn.com/images/choiyoung6609/post/c06fb808-115e-444f-80a8-d67b12c0686e/image.png)

정보를 알리기 위해서는 두 연결이 모두 사용된다. 먼저 라우터 3a는 2C에게 'AS3 x'라는 eBGP 메세지를 보내고, 2C는 AS 내 모든 라우터에게 iBGP 메세지를 보낸다. 이때 게이트웨이 라우터 2a는 eBGP 메세지 'AS2 AS3 x'를 1C에게 보낸다. 1C 라우터는 이제 iBGP를 사용해서 모든 라우터에게 정보를 전달한다.

### 3. 최적의 경로 결정
![](https://velog.velcdn.com/images/choiyoung6609/post/9101b4b8-eab6-41d2-93b6-56afd3de7690/image.png)

위의 결정처럼 서브넷 x로 향하는 경로에는 여러 개가 있을 수 있다. 그렇다면 어떤 경로를 선택해야 할까? 

=> 그 전에 우리는 먼저 **BGP 속성**을 알아야 한다. BGP 메세지는 프리픽스와 함께 BGP 속성을 같이 보낸다.(프리픽스 + 속성 = **경로**) 
- AS-PATH : 알림 메세지가 통과하는 AS들의 리스트. 루프를 방지하기도 한다.
- NEXT-HOP : AS-PATH가 시작되는 **라우터 인터페이스의 IP 주소**이다. 예를 들어 2a의 Ip 주소 등이 있다. 

BGP 경로 : NEXT HOP, AS-PATH, x ㅣㅇ렇게 기술된다.(다른 속성도 존재)

#### 뜨거운 감자 라우팅 
이제 BGP 라우팅 알고리즘을 정확하게 설명해보자. 가장 단순한 라우팅 알고리즘인 **뜨거운 감자 라우팅**이 있다. 이 알고리즘은 **NEXT-HOP 라우터까지의 경로비용이 최소**가 되는 경로를 선택하는 것이다. 이후 이 라우터로 가기 위한 자신의 라우터 인터페이스 I를 찾아낸다. 그리고 포워딩 엔트리에 (ㅌx, I)를 추가한다. 
포워딩 테이블에 AS 외부의 목적지를 추가할 때는 AS 간 라우팅 프로토콜(BGP)와 AS 내부 라우팅 프로토콜(OSPF)가 모두 사용된다. 

이 알고리즘은 **AS 외부의 비용**을 신경쓰지 않고, **AS 내부 비용**만 신경쓰기 때문에 이기적인 알고리즘이다. 또한 같은 AS 내 라우터라도 AS 이동 경로가 다를 수 있다.

#### 경로 선택 알고리즘
BGP는 뜨거운 감자 라우팅보다는 복잡한 알고리즘ㅇ르 사용한다. 일단 목적지 주소 프리픽스가 주어지면 **라우터가 알아낸 해당 목적지 까지의 모든 경로**가 BGP 경로 선택 알고리즘에 들어간다. 그리고 **제거 규칙**을 수행하여 하나의 경로만 남긴다.

**제거 규칙**
1. 속성 중 하나인 **지역 선호도** 사용. 네트워크 관리자에 의한 정책이며, **최고 지역 선호 값을 가진 경로가 선택**된다.
2. 1번 이후에도 경로가 여러 개 있다면 최단 AS-PAH를 가진 경로가 선택된다.(AS 홉 수 사용)
3. 뜨거운 감자 라우팅 수행
4. BGP 식별자 사용
