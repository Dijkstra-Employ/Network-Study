## 6.3 다중 접속 링크와 프로토콜
- **점대점 링크** : 링크 한 쪽 끝에 송신자와 수신자가 각각 하나씩 있음
- **브로드캐스트 링크** : 동일한 하나의 **공유된 채널**에 다수의 노드가 연결된다. 

- 브로드캐스트의 의미는 하나의 노드가 프레임을 전송할 떄 채널이 이를 브로드캐스트하여 다른 모든 노드가 복사본을 **수신하기 떄문**이다. 

- 이번 장에선느 브로드캐스트 링크에서 일어나는 **다중 접속 문제**에 대해서 다뤄볼 것이다. 

- 컴퓨터 네트워크에서는 **다중 접속 문제**를 조정하기 위해서 **다중 접속 프로토콜**을 사용한다. 

![](https://velog.velcdn.com/images/choiyoung6609/post/bedddce8-83f1-40db-9f70-8b7a6b3fbe84/image.png)

- 모든 노드가 프레임을 동시에 전달할 수 있지만 각 수신자에서 **충돌**할 수 있기 때문에 노드의 전송을 조정해야 한다. => **다중 접속 프로토콜**

- 다중 접속 프로토콜은 **채널 분할 프로토콜**, **랜덤 접속 프로토콜**, **순번 프로토콜**로 분류할 수 있다. 

### 6.3.1 채널 분할 프로토콜

채널을 공유하는 모든 노드가 브로드캐스트 채널 대역폭을 일부 분할할 수 있도록 해주는 기술에는 **시분할 다중화(TDM)**과 **주파수 분할 다중화(FDM)**이 있다. 

- **시분할 다중화(TDM)** : 시간을 **시간 프레임**으로 나누고 각 시간 프레임을 N개의 **시간 슬롯**으로 나눈다. 그 뒤에 시간 슬롯을 각 N개의 노드에 할당한다. 
	
    - 노드는 전송할 것이 있을 때마다 프레임 안의 슬롯 시간동안 패킷 비트들을 전송한다. (하나의 패킷 전송 시간 정도)
    - 충돌이 없고, 공정하지만, **노드가 하나인 경우에도 평균 R/N으로 제한**된다. 또한, **자신의 순서를 항상 기다려야 한다.**는 단점이 있다. 
    ![](https://velog.velcdn.com/images/choiyoung6609/post/79ab7e9b-58e8-415f-9372-f14f8172ff07/image.png)

- **주파수 분할 다중화(TDM)** : 브로드캐스트 채널을 주파수로 분할하여 N개의 노드에게 할당한다.
	- FDM은 TDM 과 같은 장단점이 있다. 충돌을 피하지만, 대역폭이 항샹 균등하게 나눠진다. (R/N 대역폭으로 한정)
    ![](https://velog.velcdn.com/images/choiyoung6609/post/057ba221-1641-47de-99da-3ac1800fda1b/image.png)

    
- **코드 분할 다중 접속(CDMA)** : CDMA는 다른 **코드를 노드에 할당**한다. 노드는 전송하는 데이터 비트를 **자신의 유일한 코드로 인코딩**한다.
	
    - 코드를 신중하게 선택하면 **동시에** 보낼 수 있고, 다른 노드들에 비해 **간섭**이 있어도, 각 수신자들이 송신자의 **인코딩된 데이터 비트를 정확하게 수신**할 수 있는 훌륭한 특성이 있다.

### 6.3.2 랜덤 접속 프로토콜
랜덤 접속 프로토콜에서는 항상 최대 전송률인 R bps로 전송한다. 이때, **충돌**이 생기면, 프레임이 **랜덤 지연 시간동안 기다린 후 재전송**하기 때문에 다음에는 충돌이 일어나지 않는다.

대표적인 랜덤 접속 프로토콜에는 알로하 프로토콜, CSMA 프로토콜이 있다.

#### 슬롯 알로하
가장 단순한 랜덤 접속 프로토콜 중에 하나인 **슬롯 알로하** 프로토콜에 대해 살펴보자

- 모든 프레임은 정확히 L 비트로 구성되고, 한 슬롯 당 L/R 초가 걸린다.(슬롯 = 프레임 전송 시간)
- 노드는 슬롯의 시작점에서 전송하고, 각 노드는 **언제 슬롯이 시작하는지 알 수 있게끔 동기화**되어 있다.
- 2개 이상의 슬롯이 충돌하면, 프레임 전달 전에 충돌 사실을 알아차린다. 

p를 확률이라고 할떄 각 노드에서 슬롯 알로하는 다음과 같이 동작한다.

- 노드는 **전송할 프레임이 있으면** 슬롯에 전체 프레임을 담아서 전송한다.
- 만약 충돌하지 않으면, 자신의 프레임을 전송한 것이다.
- 충돌했다면, 충돌 없이 전송할 때까지 **확률 p**로 해당 프레임을 **다음 슬롯들에게 재전송**한다.

![](https://velog.velcdn.com/images/choiyoung6609/post/67c7e114-a1b0-4287-b28f-91008c5542a8/image.png)

- p가 나오면 "재전송"에 해당하고, (1 - p) 가 나오면 다음 슬롯에서 동전을 다시 던지라는 의미이다.

- **슬롯 알로하 장점** : 슬롯 알로하는 **R**의 속도로 전송할 수 있게 허용한다. 또한, 각자 재전송을 결정하기 때문에 분산되어 있다.

- **슬롯 알로하 단점** : 활성 노드가 하나일 때는 잘 동작하지만, 활성 노드가 많으면 충돌로 인해 **낭비**가 일어난다. 또한, **확률로 인해 전송이 억제**될 경우 빈 슬롯을 보내 **낭비**가 일어날 수도 있다. 

- 낭비되지 않는 슬롯은 **하나만 존재하는 슬롯**이다.(성공한 슬롯) 따라서 효율성은 성공적인 슬롯의 부분으로 정의된다. 

- 이때 주어진 노드가 성공한 슬롯일 경우는 p*(1-p)^(N-1)이다. N개의 노드가 있으므로 성공확률은 Np*(1-p)^(N-1) 이다. 활성 노드가 많은 경우 최대 효율을 구하기 위해 노드가 무한대가 될 떄의 극한값을 취한다. 이렇게 계산했을 때 최대 효율은 **37%**가 나온다. => 성공 처리율이 매우 낮은 편


#### 알로하
- 슬롯 알로하 프로토콜은 **노드가 슬롯의 시작점에서 전송을 싲가**할 수 있도록 동기화되어 있었다. 그러나, 처음 알로하 프로토콜은 슬롯이 아니라 그저 **분산된 프로토콜**이었다. 

- 즉, 프레임이 도착하면 바로 브로드캐스트 채널로 전송했다. 만약 충돌이 일어난 경우 자신의 충돌된 프레임이 전송된 다음에 확률 p로 프레임을 즉시 재전송했다. **재전송하지 않을 경우** 노드는 **프레임 전송 시간**동안 기다린다. = > 유휴 상태

- 알로하의 최대 효율을 구해보자면 일단나 p의 확률로 전송을 한다고 가정하고 앞 시간대 동안 다른 프레임이 전송되면 안된다. 다른 모든 노드가 **전송을 하지 않을 확률은 (1-p)^(N - 1) **이다. 마찬가지로 뒷 시간대에서도 겹치면 안되므로 (1-p)^(N - 1) **의 확률을 가진다. 즉, 주어진 노드가 성공적인 전송을 할 경우 **p(1-p)^2(N-1)이 된다. 이는 정확히 슬롯 알로하의 **절반 효율**이다. 

![](https://velog.velcdn.com/images/choiyoung6609/post/d5551d6b-60d9-4b49-9c11-45acb6c5baf0/image.png)

#### CSMA
알로하의 단점은 다른 노드와 충돌되는 것을 고려하지 않고 자신의 노드를 보낸다는 것이다. 또한, 간섭이 일어나도 자신의 노드를 보낸다.(이후에 다시 재전송하지만)

이를 방지하기 위해서 **충돌 시간을 줄이는** 규칙을 세웠다.
- **말하기 전에 듣기** : 다른 노드가 전송하는 것을 감지하면**(캐리어감지)** 전송 중단이 감지될 때까지 기다린다.
- **다른 사람과 동시에 말하지 않기** : 중간에 간섭이 발견되면(**충돌 검출**) 자신의 전송을 바로 중단하고 **랜덤 시간 동안 기다린 후 전송**한다.

이 규칙은 CSMA와 CSMA/CD 프로토콜에 포함된다. 이러한 상황인데 어떻게 충돌이 발생하는 걸까?

![](https://velog.velcdn.com/images/choiyoung6609/post/a72a6564-5de5-48d6-8ab2-e23bd28a72a3/image.png)

위의 그림에서 먼저 t1에서 B가 시작되었다. 그러나. t2 떄 C가 전송할 프레임이 생겨서 전송한다. 사실 이때 B의 프레임이 아직 C에 도달하지 않았기 때문에 채널이 사용되지 않은 것으로 감지된다. 

위와 같이 **채널 전파 지연**, 채널 한쪽 끝에서 다른 쪽 끝으로 전파되는데 걸리는 시간에 따라서 성능이 결정된다. 

#### CSMA/CD
위의 노드들은 충돌 검출을 하지 않는다. 그러나 다중 접속 프로토콜에서 손상된 프레임을 전송하지 않으면 **프로토콜의 성능이 향상**된다. 따라서 CSMA/CD 프로토콜이 개발되었다.

> _**동작 과정**_
1. 어댑터는 데이터 그램을 받아서 프레임으로 만든 후에 어댑터의 버퍼에 저장한다.
2. 채널이 **유휴 상태**일 떄, 프레임 전송을 시작하낟. 
3. 전송하는 동안 다른 어댑터로부터의 신호 에너지가 있는지 감시한다. 
4. 다른 에너지가 감지 되지 않으면 그대로 종료되고, 다른 에너지가 감지되면 즉시 전송을 중지한다.
5. 랜덤 시간만큼 기다린 다음 2단계로 돌아가서 다시 동작한다.

**랜덤 백오프**시간을 정하는데 사용되는 시간 간격은 어떻게 정하는 게 좋을까?
- 시간 간격이 크고, 충돌한 노드 수가 작다면 **기다리는 시간이 많아**진다.
- 시간이 작고, 충돌한 노드가 많으면 **계속해서 다시 충돌**한다.

=> DOCSIS 케이블 네트워크 다중 접속 프로토콜 뿐만 아니라 **이진 지수적 백오프 알고리즘**은 이 문제를 효율적으로 해결한다.

1. 충돌을 N 번 경험한 프레임을 전송할 떄 노드는 {0, 1, 2, ... 2^n - 1} 중에서 랜덤하게 K 값을 선택한다.(n은 최대 10)
2. 노드가 실제로 기다리는 시간은 K+512비트 시간(이더넷으로 512 비트를 전송하는데 필요한 시간)

#### CSMA/CD의 효율
단 하나의 프레임의 경우 전속력으로 전송 가능하다. 
그러나, **많은 노드**가 있을 경우, 채널의 실제 전송률은 줄어든다. 즉, 오랜 시간 동안 다수의 활성 노드들이 있을 떄 충돌 없이 프레임이 채널로 전송되는 시간 비율이다. 

> 효율 = 1 / (1 + 5ddrop/dtrans)

ddrop이 0이 되면 거의 1에 근접하는데, 전파 지연이 0이 되면 충돌이 일어나도 바로 취소하기 떄문이ㅏㄷ. dtrans는 최대 크기의 이더넷 프레임을 전송하는데 걸리는 시간으로 이 값이 큰 경우 효율은 1에 근접하다.(아주 오랫동안 채널을 사용하기 떄문)

### 6.3.3 순번 프로토콜
다중 접속 프로토콜의 두 가지 특성으로는 1) 하나의 노드 전송시 R bps 전송률, 2) 여러 노드 전송 시 R/M bps 처리율을 갖는다는 것이다.

알로하와 CSMA 프로토콜은 첫 번쨰 특성은 가지고 있지만, 분할해서 전달하는 특성은 덦다. 따라서 **순번 프로토콜**을 개발하게 된 것이다. 

**1) 폴링 프로토콜**
- 노드 중 하나를 마스터 노드로 지정하여 라운드 로빈 방식으로 각 노드를 **폴링**한다. < 폴링 : 다른 장치의 상태를 주기적으로 검사하여 일정한 조건을 만족할 때 송수신 등의 자료 처리를 하는 방식 >
- 노드 1에게 최대로 보낼 수 있는 프레임 수 정보를 가진 메세지를 보내고, 이후 노드 2에게 노드 2가 최대로 보낼 수 있는 프레임 수를 알려준다. 
- 이 방식은 **충돌도 없애고, 빈 슬롯도 제거**함으로써 높은 효율을 제공한다.
- 그러나, **폴링 지연**이 발생하여 최대 개수만큼 프레임을 보내도 폴링으로 인해 R bps보다 작은 전송률로 전달하게 된다.
- 또한, **마스터 노드가 고장**나면 전체 채널이 동작하지 못하게 된다.

**2) 토큰 전달 프로토콜**
- 마스터 노드가 없고, **토큰**이라고 하는 특수 목적 프레임이 정해진 순서대로 노드 간에 전달된다. (노드 1은 2에게 2는 3에게 ... N은 1에게)
- 노드가 토큰 수신 시 전송할 프레임이 있을 때만 토큰을 붙잡고 아니면 토큰을 다음 노드로 전달한다.(프레임을 최대 개수까지 전송)
- 효율이 매우 높지만, 노드 하나에서 **실패**하면 **전체 채널이 동작하지 않는다**.
- 또한, 노드 하나가 토큰을 놓아주지 않는다면 다시 돌아올 수 있도록 하는 **회복 장치가 필요**하다. 


### 6.3.4 DOCSIS : 케이블 인터넷 접속을 위한 링크 계층 프로토콜
DOCSIS는 케이블 데이터 네트워크와 프로토콜을 정의한다. 즉, CMTS와 케이블 모뎀들을 연결한다. 
![](https://velog.velcdn.com/images/choiyoung6609/post/9b3ddd44-09ac-4dc2-b61f-653598424f7f/image.png)

- 각 하향 및 상향 네트워크 세그먼트들을 다수의 주파수 채널로 나누기 위해 FDM을 사용했다.
- CMTS에 의해 하향으로 전송되는 경우 충돌이 일어나지는 않지만 상향 채널로 전송하는 경우에는 **다중 접속 문제**가 발생한다.
- 상향 처리는 TDM으로 나뉘어져 있고, 각 시간 간격은 일련의 미니슬롯 들로 구성되어 있다. 
```
우리는 이와같이 FDM과 TDM을 조합하여 사용하는 경우가 많다.

간단한 예를 들어서 설명하자면, 케이블 TV 시스템에서는 
FDM을 사용하여 각 TV 채널을 개별적인 주파수 대역으로 분할한다.
그리고 각 TV 채널 내에서 TDM을 사용하여 여러 사용자가 
시간을 분할하여 사용할 수 있게 한다.
```


- CMTS는 하향 채널로 t1, t2에 대한 MAP 프레임을 보내 명시된 시간 간격 동안 어떤 미니슬롯으로 전송할 수 있는지 알려준다. CMTS는 미니슬롯 동안에는 충돌하지 않는다. 
- 미니슬롯 요청 프렝미을 CMTS로 전송함으로써 **케이블 모뎀에 전송할 데이터가 있는지** 알 수 있다. 
- 충돌이 발생한 것으로 추정한 케이블 모뎀은 미니슬롯 요청 프레임의 재전송을 지연시키기 위해 이진 지수적 백오프를 사용한다. 
