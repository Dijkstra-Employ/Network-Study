## 6.4 스위치 근거리 네트워크 
이전에 브로드캐스트 네트워크와 다중 접속 프로토콜에 대해서 공부했다. 이번에는 **스위치 근거리 네트워크**에 대해서 공부해보자!

![](https://velog.velcdn.com/images/choiyoung6609/post/e4c1fa65-3f99-49a4-ab71-d3325b338a63/image.png)

위의 그림은 다양한 노드를 연결해주는 근거리 네트워크를 나타낸다. 여기서 스위치는 **링크 계층**에서 동작하기 때문에 **링크 계층 프레임을 교환**하고, 네트워크 계층 주소를 인식하지 않으며, OSPF 같은 라우팅 알고리즘을 사용하지 않는다. 

### 6.4.1 링크 계층 주소체계와 ARP
호스트와 라우터는 링크 계층 주소를 갖는다. 이들은 또한 네트워크 계층 주소도 갖는다. 그렇다면 **왜 링크 계층 주소와 네트워크 계층 주소 모두 필요**한 것일까? + **ARP 프로토콜은 무엇일까?**

#### MAC 주소
실제로 호스트와 라우터가 MAC 주소를 가지고 있는 것이 아니라, 호스트와 라우터의 **어댑터**가 **MAC 주소를 가진다.** 따라서 호스트와 라우터는 여러 개의 링크 계층 주소를 갖는다. 

그러나 **링크 계층 스위치**는 인터페이스에 링크 계층 주소를 할당받지 않는다. 그 이유는 호스트와 라우터는 스위치의 주소를 명시하지 않고, 그저 데이터그램을 **전달**하는 일만 하기 때문이다. 

여기서 **링크 계층 주소**는 **랜 주소**, **물리 주소** 또는 **MAC 주소**라고도 불린다. MAC 주소는 6바이트로 이루어져 있으며 2개의 16진수씩 묶어서 표현된다. 원래 **영구적**이었으나, 소프트웨어를 사용해서 MAC 주소를 변경할 수 있게 되었다.

![](https://velog.velcdn.com/images/choiyoung6609/post/83599807-1ae9-40b1-81ba-66e87714a351/image.png)

MAC 주소의 _놀라운 점_은 **어떤 MAC 주소도 겹치는 일이 없다**는 것이다. 그 이유는 IEEE가 MAC 주소 공간을 관리하기 때문이다. 어댑터를 제조하기 위해서는 2^24로 이루어진 주소 영역을 구매해야 한다. 즉, IEEE에서는 **첫 24비트를 고정**하고, 나머지를 **회사가 부여**하는 방식으로 할당하였다.

MAC 주소는 평면 구조를 가지며 주소가 고정된다. 즉, 이더넷 카드 또는 무선 인터페이스를 가진 기기들은 어디서든 **동일한 MAC 주소**를 갖는다는 것이다. 반면에 **IP 주소**는 **계층 구조(서브넷 마스크를 이용한 네트워크 부분과 호스트 부분)**를 가지고 있으며, 호스트가 **이동 시 변경**되어야 한다. 
```
MAC 주소 - 주민등록번호
IP 주소 - 우편 주소
```

가끔식 스위치는 프레임을 모든 인터페이스로 브로드캐스팅 하는 경우가 있다. 이 때 어댑터는 **자신의 주소와 프레임 안의 목적지 주소**를 비교하고 일치하다면 **데이터 그램을 추출***해서, **프로토콜 스택의 위쪽으로 전달**한다. 만약 일치하지 않는다면, **프레임을 폐기**한다. 

 그러나 때때로, 모든 어댑터에서 자신이 보낸 프레임을 **수신**하기를 바랄 경우 **MAC 브로드캐스트 주소**를 사용하여 보내면 된다.(FF-FF-FF-FF-FF-FF)
 
> IP 주소와 MAC 주소가 모두 필요한 이유
- **IP Address로만 통신하면 안되는 이유** : 라우팅 기법은 패킷에 포함된 IP 주소를 추적해서 최단 경로를 선택해간다. IP 주소는 논리 주소이기 때문에 IP 주소로 패킷을 보낸 뒤에 IP에 등록된 MAC Address로 변환되어 그 컴퓨터로 패킷을 전송하게 된다. 즉, IP 주소로만 통신할 경우, 네트워크 내에서 물리적 장치를 구별하기 어렵기 때문에 MAC 주소로 변환해야 한다.<물리적 장치 구분 - 컴퓨터, 서버, 스마트폰 등>
- **MAC Address로만 통신하면 안되는 이유** : 특정 웹 서버를 찾을 때 ISP가 모든 MAC 주소를 가져야 한다. 즉, 하나하나 라우팅이 필요하다. 그러나, IP는 **지역별, 네트워크 별**로 계층화되어 있기 때문에 라우팅에 효과적이다. 
 
#### ARP
ARP란 네트워크 계층 주소(IP 주소)와 링크 계층 주소(MAC) 주소를 **변환시켜 주는 프로토콜**이다.
![](https://velog.velcdn.com/images/choiyoung6609/post/7cf579dc-4b53-4252-b2cc-4c6566a7f42c/image.png)

위의 예시를 통해 같은 네트워크 내에서 어떻게 패킷이 전달되는지 알아보자. 앞에서 알아봤듯이 패킷을 전달하기 위해서는 **목적지 호스트의 IP 주소**와 **MAC 주소**가 모두 필요하다. 이때 출발지 호스트에서는 목적지 호스트의 IP 주소만을 알뿐, **MAC**주소를 모르기 때문에 **ARP 프로토콜**을 사용해야 한다. 

> **ARP 프로토콜** : **동일한 서브넷**에 이쓴 호스트와 라우터 인터페이스에 대한 IP 주소를 MAC 주소로 변환해준다.

먼저 각 호스트에는 **ARP 테이블**이 있고, ARP 테이블에는 IP 주소와 MAC 주소의 매핑, 그리고 **TTL 값**이 들어가 있다.(모든 항목이 존재하지는 않음)
 호스트가 해당 서브넷의 다른 호스트에게 데이터그램을 보낼 때 **ARP 테이블**을 확인한다. 그러나, 만약 ARP 테이브에 해당 값이 없다면 **ARP 패킷**이라는 특수 패킷을 보낸다.
 
> **ARP 패킷** : 서브넷에 있는 다른 호스트와 라우터를 확인하여 확인하려는 **IP 주소에 해당하는 MAC 주소 확인**하는 것

호스트는 목적지 호스트의 MAC 주소를 모르기 떄문에 **브로드 캐스트 주소**로 ARP 패킷을 전달한다.(모든 호스트의 ARP 모듈까지) 목적지 호스트가 해당 패킷을 받게 되면 **매핑 값을 포함한 응답 ARP 주소**를 쿼리 호스트에게 보낸다. 

ARP는 **플러그 앤 플레이 방식**으로 관리자가 신경쓸 필요 없이 자동으로 구축된단느 특징이 있다.  또한, 네트워크 계층과 링크 계층의 특징을 모두 가지고 있는 프로토콜이다.(경계를 넘나드는 프로토콜)

#### 서브넷에서 데이터그램 보내기
다른 서브넷으로 보낼 때는 어떻게 해야 할까?

1) 출발 호스트에서 패킷의 헤더에 **목적지 호스트 IP**와 **홉 라우터의 MAC 주소**를 포함한 데이터 그램을 보낸다.(ARP를 통해 MAC 주소 획득)

2) 홉 라우터에서는 자신의 MAC 주소가 포함된 것을 확인하고 **라우터의 네트워크 계층로 전달**한다.

3) 라우터에서 목적지로 데이터그램을 이동하기 위해 라우터의 테이블을 참조하여 **올바른 인터페이스로 전달**한다. 

4) 이 인터페이스는 데이터그램을 **어댑터로 전달**하고, 어댑터에서 서브넷으로 데이터그램을 전달한다. 이때 프레임의 목적지 MAC 주소는 ARP 주소를 통해서 얻는다.(최종 목적지일 경우 목적지 MAC 주소와 최종 목적지 MAC 주소가 서로 일치)

### 6.4.2 이더넷
현재 이더넷은 **유선 LAN 시장**을 **거의 장악**했다. 그러나 처음에는 다른 기술들과 경쟁했고, 그 과정 속에서 계속 **진화하고 성장**한 것이다. 

> #### **이더넷의 성공 이유**
1) 가장 널리 배포된 고속 LAN - 이미 널리 사용됨
2) 다른 기술은 복잡하고 비용이 많이 들었음
3) 이더넷이 다른 기술에 비해 데이터 전송 속도가 **비등하거나 빠름**
4) 이더넷 하드웨어가 상품으로서 존재하여 **저렴했음**

- 이더넷은 처음 1990년대 중반까지는 노드를 **상호연결**하기 위해 **동축 버스**를 사용했다.(브로드캐스트 LAN) 
- 1990년대 후반까지는 **허브 기반 스타 포폴로지**를 사용했다. 이 설비는 비트를 간단히 재생성하고 에너지 강도를 높인 후 모든 인터페이스로 전달하는 **브로드캐스트 LAN**이었다.
- 2000년대 초, 중앙의 허브 대신 **스위치**가 사용되는데 **충돌이 없을**뿐만 아니라 **진정한 전달 패킷 스위치**가 된 것이다.


#### 이더넷 프레임 주소
![](https://velog.velcdn.com/images/choiyoung6609/post/33e8b56c-9a35-4ed4-b71b-477db82bd920/image.png)

위는 이더넷 프레임의 구조이다. 두 호스트가 **동일한 이더넷 LAN**에서 패킷을 전달하는 예시를 통해 이더넷 프레임의 **여섯 가지 필드**를 생각해보자.

- **데이터 필드(46 ~ 1500 바이트)** : 최소 46바이트에서 최대 1500바이트를 채워야 한다. 46 바이트가 안될 경우 **스터핑**을 통해서 User data 부분을 채운다.(네트워크 계층 헤더의 길이 필드 사용해 스터핑 제거) 만약 1500바이트가 넘을 경우 **조각화**를 진행한다.

- **대상 주소(6바이트)** : 목적지 어댑터의 **MAC 주소**가 들어가져 있다. 여기에 브로드캐스트 주소를 넣으면 모든 어댑터에서 이 데이터그램을 처리한다.

- **소스 주소(6바이트)** : 프레임을 **LAN으로 전송하는 어댑터의 MAC 주소**가 포함된다.

- **유형 필드(2바이트)** : 이더넷은 **여러 네트워크 계층 프로토콜**을 사용할 수 있도록 **다중화**하였다. 각 프로토콜은 보통 **표준화된 유형 번호**를 가지고 있다. 

- **순환 중복 검사(CRC)(4바이트)** : 수신 어댑터에서 **비트 오류를 감지**할 수 있도록 하는 것이다.

- **프리앰블(8바이트)** : 이더넷은 맨 앞에 **프리앰블 필드**로 시작한다. 이때 처음 7바이트는 10101010을 가지며 마지막 한 바이트는 10101011의 값을 가진다. 처음 7바이트는 전송 과정에서 생긴 **약간의 오차(드리프트)**시간을 송신자와 수신자의 클록이 서로 **동기화**하도록 한다. 마지막 한 바이트는 수신자 어댑터에게 _중요한 데이터가 올 것이라는_ **알람**을 보낸다.

> **이더넷의 특징**
- 연결 없는 서비스 제공(no 핸드쉐이크)
- 신뢰성 없는 서비스

#### 이더넷 기술
이더넷은 사실 단일 프로토콜이 아닌 **여러 형태로 제공**된다. ex) 10GBASE-T, 40GBASE-T

- 처음 부분은 **표준의 속도**를 의미한다.
- BASE는 기저대역 이더넷을 의미하며, 물리적 미디어가 **이더넷 트래픽만 전달**한다는 것을 의미한다.
- 마지막 부분은 **물리적 미디어 자체**를 나타낸다. ex) 동축 케이블, 구리선, 광섬유 등

역사적으로 이더넷은 **동축 케이블의 한 부분**으로 생각되었다. 그러나 현재는 **꼬인 쌍 구리선이난 광섬유 케이블**로 만들어진 **지점 간 세그먼트**를 통해서 스위치에 연결된다.

![](https://velog.velcdn.com/images/choiyoung6609/post/a0a19083-2bad-4dbd-b7d5-9ef2e9ae7f9d/image.png)

802.3z라고 하는 **기가비트 이더넷 표준**은 아래를 수행한다.

- 표준 이더넷 프레임 형식을 사용하며, 다른 기술과 **역호환**된다. (쉽게 통합 가능)
- 포인트 투 포인트 링크는 **스위치**를 사용하고, **공유 브로드캐스트 채널**은 **허브**를 사용한다. 
- 공유 브로드캐스트 채널에 충돌에 대처하기 위해 **CSMA/CD**를 사용한다. 
- 채널 간 양반향으로 40Gbps의 풀 듀풀렉스 작동을 허용한다.

과거 **버스 토폴로지** 또는 **허브 기반 스타 토폴로지**가 주로 사용되었다. 이들은 **브로드캐스트 링크**이기 때문에 이를 처리하기 위해 **CSMA/CD** 프로토콜을 사용했다. 그러나 현대에는 **스위치 기반의 스타 토폴로지**가 사용되며 이떄 **스토어 앤 포워딩** 방식을 사용하기 떄문에 **이더넷 MAC 프로토콜**이 필요하지 않아졌다.(충돌 없음)


### 6.4.3 링크 계층 스위치
스위치의 역할에 대해서 자세하게 알아보자! 스위치는 호스트/라우터에게 **투명하다**즉, 호스트와 라우터는 중간에 스위치가 패킷을 받아 전달하는 것을 알지 못한다. 또한, 패킷이 스위치에서 출력할 때 버려지는 일을 방지하기 위해서 **버퍼**도 가지고 있다.

#### 포워딩과 필터링
**필터링**은 프레임을 폐기할지 결정하는 작업을 의미하고, **포워딩**은 프레임이 전달될 인터페이스를 결정하고 그 인터페이스로 보내는 것을 의미한다. 이때 **스위칭 테이블**을 이용하는데 MAC 주소, 보낼 인터페이스, 시간 정보가 포함되어 있다. 

![](https://velog.velcdn.com/images/choiyoung6609/post/52a652b2-18d2-426a-ac77-159f11fba8a0/image.png)

- **테이블에 MAC 주소가 없는 경우** : 프레임의 복사본을 브로드캐스팅한다. 
- **테이블에 MAC 주소가 있는데, 도착 인터페이스와 일치하는 경우** : 프레임을 제거하여 필터링한다.
- **테이블에 MAC 주소가 있고, 도착 인터페이스와 일치하지 않는 경우** : 해당 인터페이스로 포워딩한다.

#### 자가학습
스위치 테이블은 자동으로, 동적으로, 자치적으로 구축하는 특성이 있다. 즉, **자가학습**을 한다.

1. 초기에 테이블이 비어있다.
2. 도착한 프레임에 대해 출발지 MAC 주소, 프레임이 도착한 인터페이스, 현재 시간을 테이블에 저장한다. 랜에 있는 모든 호스트가 프레임을 송신하면, 모든 호스트에 대한 정보가 기록된다.
3. 일정 시간이 지난 후에 스위치가 해당 주소를 출발지 주소로 하는 프레임을 수신하지 못하면 이 주소를 삭제한다.

=> 관리자가 개입하지 않으므로 **플러그 앤 플레이 장치**이다. 또한, 전이중이기 떄문에 노드와 스위치는 링크에서 충돌할 일이 없다.

#### 링크 계층 스위치의 특성
버스나 허브 기반의 스타 포폴로지같은 **브로드캐스트 링크**가 아닌 스위치를 사용하면 다음과 같다.

- **충돌 제거** : 스위치는 충돌이 없기 때문에 낭비되지 않는다. 또한, 최대 총 처리율은 **모든 인터페이스 속도의 합**이기 떄문에 랜보다 성능이 훨씬 향상된다.
- **이질적인 링크들** : 스위치는 링크를 별도로 분리하기 떄문에 각 링크는 상이한 속도, 상이한 매체를 갖는다. 
- **관리** : 스위치는 향상된 보안과 네트워크 관리를 할 수 있게 해준다. 스위치는 대역폭 사용, 충돌률, 트래픽 종류에 대한 통계치를 수집하여 네트워크 관리자가 사용할 수 있게 만들었다. 

#### 스위치 대 라우터
라우터는 IP 주소를 사용하는 3계층 패킷 스위치인 반면에 스위치는 MAC 주소를 사용하는 2계층 패킷 스위치이다. 그렇다면 두 장치의 차이점은 무엇일까?

> **스위치** 
 플러그 앤 플레이 장치이며 상대적으로 _높은 패킷 필터링 및 전달률_을 갖는다. 그러나, 브로드 캐스트 프레임의 순환을 막기 위해서 토폴로지는 **스패닝 트리**로 제한하였다. 또한, 스위치는 **브로드캐스트 트래픽의 폭주**에 대한 방안을 제공하지 않는다. 
 
> **라우터**
IP 주소는 계층적이므로 패킷이 순환하지는 않는다. 또한, **브로드캐스트 폭풍**에 대비한 방화벽 보호 기능이 있다.. 그러나 **플러그 앤 플레이 방식이 아니고**, **3계층까지 처리**해야 하므로 시간이 더 길어진다.

### 6.4.4 가상 근거리 네트워크(VLAN)
현대 기관에서의 LAN은 부서 별로 별도의 스위치 랜을 가지고 있고, 이러한 스위치 랜은 스위치 계층구조를 통해서 연결되어 있다고 했다.(계층적 구성) 그러나 실제 상황에서는 _제대로 동작하지 않는다._


- **트래픽 격리의 부족** : 부서 별로 단일 스위치로 격리해주지만, 브로드캐스트 트래픽은 여전히 전체 네트워크로 전달된다. **브로드캐스트 트래픽의 전달 범위를 제한하면** 랜 성능을 향상할 수 있고, 보안/개인보안이 가능해진다. 이러한 트래픽 제하는 **중앙 스위치를 라우터로 변경**할 경우 가능해진다. 

- **스위치의 비효율적인 사용** : 기관에 그룹이 3개가 아닌 10개가 있는 경우 첫 단계 스위치는 10개가 필요하다. 그러나 인원 수가 10명보다 작다면 하나의 스위치에 모든 사람 수용이 가능해진다. 그러나 스위치 하나로는 **트래픽 격리를 할 수 없다**는 문제가 있다. 즉, 모든 트래픽이 같은 네트워크 상에서 처리되고, 네트워크가 분리되지 않으며 보안상의 문제가 발생할 수 있다. 

- **사용자 관리** : 다른 부서로 이동하는 경우 **물리적 케이블 연결**을 변경해야만 한다. 


이러한 문제들은 **가상 근거리 네트워크(VLAN)**에 의해서 해결될 수 있다. 즉, 하나의 LAN에서 여러 LAN 들로 정의할 수 있게 되는 것이다. 

![](https://velog.velcdn.com/images/choiyoung6609/post/ce58b535-ad56-4d95-9a30-31c414046796/image.png)

포트-VLAN 매피 테이블은 스위치ㅔ서 관리되며 스위치 하드웨어는 같은 VLAN에 속한 포트들 간에만 프레임을 전달한다.

> _그렇다면 만약 같은 스위치, 다른 VLAN에 속할 경우 어떻게 소통할까?_
 
이 문제는 VLAN 스위치 포트(그림 상 1번)를 외부 라우터에 연결하고 **이 포트를 각 VLAN 모두에게 속하게 하면 된다**. 두 VLAN은 물리적 주소는 같을 지언정 **논리적 주소는 다르기 때문에** 별도의 스위치를 가지는 것처럼 처리된다. 

> _그렇다면 일부가 별도의 건물에 있지만 자신의 부서의 VLAN에 연결되고 싶은 경우, 어떻게 해야할까?_
 
 ![](https://velog.velcdn.com/images/choiyoung6609/post/066a433c-08e8-4872-ac4f-859142aa846b/image.png)

첫 번째 방법은 하나의 별도 스위치를 생성하고 스위치의 별도 포트 하나를 **해당 부서 VLAN에 속하게 한 다음에 이들 포트를 서로 연결**해주면 된다. 그러나 이 방법은 두 스위치를 연결하기 위해 N개의 VLAN이 있는 경우 스위치마다 N개의 포트들이 필요하기 떄문에 **확장 문제**가 있다.

두 번쨰 방법은 **VLAN 트렁킹** 방식이 있다. VLAN 트렁킹 방법에서는 **스위치마다 하나의 특수 포트가 2개의 VLAN 스위치를 연결하는 트렁크 포트로 구성**되어 있다. 이때 **확장된 이더넷 형식인 802.1Q**를 통해서 트렁크 포트로 온 프레임이 어떤 VLAN에 속하는지 구분한다. 

![](https://velog.velcdn.com/images/choiyoung6609/post/fd8a217a-0983-4546-b22c-f6fefe6a395a/image.png)

