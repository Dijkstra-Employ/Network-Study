## P2P 파일 분배
지금까지 공부한 애플리케이션은 모두 always-on한 서버에 의존한 client-server 구조였다. **P2P 구조**는 **서버에 최소한으로(또는 전혀) 의존한다는 것**을 명심해야 한다. 대신 간헐적으로 연결되는 _호스트 쌍들이 서로 직접 통신한다._

이번 절에서는 _커다란 파일을 한 서버에서 다수의 호스트(피어)로 분배_하는 **P2P 어플리케이션**에 대해서 배울 것이다. 또한, 2020년대 이수 가장 인기있는 **P2P 파일 분배 프로토콜인 비트토렌트**에 대해서 공부해볼 것이다.

### P2P 구조의 확장성
P2P 구조의 자가 확장성과 클라이언트-서버 구조와의 비교를 위해서는 한 파일을 N개의 호스트(피어)에 분배하는 간단한 양적 모델을 고려해봐야 한다.

- 서버이 접속 링크 업로드 속도 Us
- i번쨰 피어의 접속 링크 업로드 속도 Ui
- i 번째 피어의 접속 링크 다운로드 속도 di
- 분배되는 파일의 크기 Fbit
- 피어의 수 N

여기서 분배 시간이란 N개의 피어가 파일의 복사본을 얻는 데 걸리는 시간이다. 

![](https://velog.velcdn.com/images/choiyoung6609/post/90bee622-916b-4761-98df-d09886f61d52/image.png)

--- 
**클라이언트 - 서버 구조에서의 분배 시간 Dcs**
- 서버는 파일 복사본을 N개의 피어(호스트)에게 직접 전송해야 하기 때문에 총 NF 비트를 전송해야 하며 이를 서버의 업로드 속도로 나누면 NF/Us가 된다.
- dmin이란 가장 낮은 다운로드 속도를 가지는 피어의 다운로드 속도를 나타낸다. 가장 성능이 좋지 않은 피어의 다운로드 속도는 N/dmin이다.

따라서 클라이언트 - 서버 구조에서 부냅 시간은 아래와 같다.

![](https://velog.velcdn.com/images/choiyoung6609/post/d439810c-5dde-4470-9289-7b1051b05590/image.png)

이 식은 만약 다운로드 속도가 정상적이고 N이 충분히 큰 상황에서 보통 클라이언트-서버의 분배 시간이 NF/Us라는 뜻이다. 즉, 분배 시간이 N에 따라 **선형적으로 증가**할 수 있다.

---
**P2P 구조에서의 분배 시간 Dcs**
P2P 구조의 특징은 각 피어들이 자가 확장할 수 있다는 것이다. 즉, 한 피어가 파일 데이터의 일부를 수신하고 이를 업로드하여 다른 피어들에게 재분배할 수 있기 때문이다.
이 구조는 다른 피어들에게 어떻게 분배하는지에 따라 분배 시간이 달라지겠지만 최소 분배 시간을 구하는 것은 간단한 수식을 이용하여 구할 수 있다.

- 서버는 한 번은 파일을 피어 커뮤니티에 업로드해야 하기 때문에 최소 F/Us의 시간이 필요하다.
- 클라이언트 - 서버 구조와 마찬가지로 가장 성능이 낮은 피어는 F/dmin 의 최소 분배 시간을 가진다.
- 마지막으로, 한 번 파일을 다운로드한 후에는 피어들도 업로드할 수 있는데 한 파일을 모두 다운로드한 다음에 업로드 하는 것이 아닌 일정 부분(chuck) 다운로드하면 그때부터 다운받은 부분을 전달할 수 있다. 따라서 **원래 서버의 업로드 속도 + 피어들의 업로드 속도의 합 = 전체 업로드 속도**이고, NF 비트를 업로드해야 하므로 이때 걸리는 시간은 NF/(Us + U1 + ... + Un)이다.

![](https://velog.velcdn.com/images/choiyoung6609/post/f9c5e3dc-b55a-472f-8c94-21b92284e083/image.png)

현실에서는 각 비트를 재분배하기보다는 **파일의 청크(chuck)가 재분배되는데** 위의 그림은 최소 분배 시같에 대한 좋은 근사값을 제시한다.

![](https://velog.velcdn.com/images/choiyoung6609/post/21344b5f-4588-4dd1-a331-1c278659c21f/image.png)
다음은 모든 피어가 같은 업로드 속도 u를 가지고 있다고 가정하고, F/u가 1시간, Us = 10u, dmin >= Us로 설정한 것이다. 

이때 그래프를 보면 알 수 있듯이 P2P의 최소 분배 시간은 항상 client - server 구조의 최소 분배 시간보다 작으며, 피어가 몇 개이든지 1시간 이하의 시간이 걸린다. **즉, P2P 구조를 가진 애플리케이션을 자가 확장성을 가진다.**

### 비트 토렌트
비트 토렌트는 가장 인기있는 P2P 프로토콜이다. 비트 토렌트는 특정 파일의 분배에 참여하는 모든 피어들의 모임을 **토렌트**라고 부른다. 

토렌트에 참여하는 피어들은 같은 크기의 청크(chuck)를 다운로드한다. 피어가 처음 토렌트에 가입할 때는 가진 청크가 없으나 시간이 지날수록 청크가 늘어나며 피어는 모든 청크를 가지고 있을수도, 아니면 떠날 수도, 일부만 가질 수도 있다.(재가입도 가능)

하나의 토렌트는 **트래커(tracker)라고 부르는 인프라스터럭처 노드**를 가지고 있다. 피어가 토렌트에 들어왔을 때 트래커에 자신을 알리고 일정 주기로 계속 자신이 존재함을 알린다. 

> **이웃 설정하기**
- 새로운 피어(A)가 가입할 때 트래커는 피어 집합에서 임의로 피어의 부분집합을 선택하여 이 피어들의 IP 주소를 새로운 피어(A)에게 보낸다. 
- A느 모든 피어와 동시에 TCP 연결을 설정하고 성공적으로 연결된 이들을 **이웃 피어**라고 부른다. 
- 이웃 피어들은 시간에 따라 변경된다.

#### 청크 교환 방식
> **청크 가져오기(다른 Peer로부터 청크 받기)**
1. 토렌트 내의 각 피어들은 파일 청크들의 일부를 보유하고 있다.
2. 주기적으로 이웃 피어들에게 그들이 가진 청크 목록을 요청한다. 
3. 자신이 가지고 있지 않은 청크에 대해 요구한다.
->  **rarest first 기술을 사용**
-> 자신이 가지고 있지 않은 청크 중, 이웃이 가장 잘 가지고 있지 않은 희귀한 청크 요구
-> 해당 청크를 보유하고 있는 Peer에게 변동이 발생할 수 있기 때문(Peer Churn, 나에게 청크를 공유해주는 피어가 사라지는 경우)

> **청크 보내기(다른 Peer에게 청크 업로드)**
"나에게 청크를 잘 주는 피어에 대해 나도 청크를 잘 공급해 줘야 겠다."
1. **_<span style="color:red">10초마다</span>_** 나에게 청크를 잘 공급해주는 4개의 피어를 결정한다. -> 활성화(unchoked)
-> 그러나 이렇게 되면 일부의 Peer에게만 계속해서 공급해주는 문제가 발생한다.

2. **_<span style="color:red">30초마다</span>_** 임의로 하나를 추가로 선택하여 그것에게 청크를 보낸다. -> 낙관적 활성화(optimistically unchoked) 
-> 이러면 상대편의 4개 피어 중 하나에 속하게 되기 때문에 임의로 선택된 피어에서 데이터를 보내기 시작한다.
-> 상대가 데이터를 보내는 속도가 충분히 높으면 4개 피어 중 하나에 속하게 된다.

이러한 보상 방식을 TFT(tit for tat)dlfkrh gkau Selfish Peer들이 살아남지 못하도록 만들어준다.
