## 네트워크 계층 개요

네트워크 계층은 상대 호스트의 트랜스포트 계층으로부터 세그먼트를 얻어 각 세그먼트를 데이터그램으로 캡슐화하고 인접한 라우터에게 데이터그램을 보낸다.

수신 호스트의 네트워크 계층은 트랜스포트 계층 세그먼트를 추출하여 트랜스포트 계층까지 전달한다.

각 라우터의 역할은 입력 링크에서 출력 링크로 데이터그램을 전달하는 것이다.

네트워크 계층은 best effort service(최선형 서비스) 프로토콜을 제공한다.

최선형 서비스는 패킷을 보내는 순서대로 수신됨을 보장할 수 없을 뿐만 아니라, 목적지까지의 전송 자체도 보장할 수 없다.

종단 시스템 간 지연 또한 보장되지 않으며, 보장된 최소 대역폭 또한 없다.

즉, 최선을 다해서 데이터그램을 전달하고자 하지만, delay, loss 등의 문제가 발생할 수 있다.

<br />

## 포워딩과 라우팅

네트워크 계층의 근본적인 역할은 송신 호스트에서 수신 호스트로 패킷을 전달하는 것이다.

<br />

### 포워딩

패킷이 라우터의 입력 링크에 도달했을 때, 라우터는 그 패킷을 적절한 출력 링크로 이동시켜야 한다.

포워딩 테이블을 채우는 것은 라우팅 알고리즘을 통해 한다.

포워딩은 매우 짧은 시간 단위를 갖기에, 대표적으로 하드웨어에서 실행된다.

<br />

### 포워딩 테이블

포워딩 테이블이 만들어지면 입력 포트에 독립적으로 포워딩 테이블이 카피되어 저장된다.

입력포트에서 포워딩 테이블의 매칭이 이뤄지는 것 보단 데이터 입력의 속도가 더 빠를 수 있으므로, 입력 포트 안에 큐가 존재하여 이를 관리한다.

마찬가지로, 아웃풋 포트에도 큐가 존재한다.

<br />

**[ 포워딩 테이블이 구성되는 방법 ]**

라우팅 알고리즘이 라우터의 포워딩 테이블의 내용을 결정한다.

라우팅 알고리즘은 각각의 모든 라우터에서 실행되며, 라우터는 포워딩과 라우팅 기능을 모두 갖고 있어야 한다.

한 라우터의 라우팅 알고리즘 기능은 다른 라우터의 라우팅 알고리즘과 소통하며 포워딩 테이블의 값을 계산한다.

즉, 라우팅 프로토콜에 따라 라우팅 정보에 포함된 라우팅 메시지를 교환하며 이루어진다.

<br />

### 라우팅

송신자가 수신자에게 패킷을 전송할 때 네트워크 계층은 패킷 경로를 결정해야 한다.

이러한 경로를 계산하는 알고리즘을 라우팅 알고리즘이라 한다.

라우팅은 네트워크 전반에 걸쳐 출발지에서 목적지까지 데이터그램의 종단 간 경로를 결정하기 때문에 더 긴 시간이 걸려 소프트웨어에서 보통 실행된다.

<br />

### 라우터

여러 인터페이스를 가지는 디바이스이며, 인터페이스마다 각각의 IP(subnet)를 갖는다.

여러 개의 subnet에 속해있는 중간자이다.

그렇기에 다른 Subnet에 접근하고자 할 때는 공유 지역인 라우터를 거쳐갈 수밖에 없다.

<br />

### 라우팅 테이블

Destination Address Range에 맞는 link에 데이터를 전송한다.

어쩔 땐 여러 개의 entry에 매칭이 되는 경우가 있다.

이 경우엔 longest address prefix라고 가장 길게 매칭이 되는 Entry를 찾아서 전송한다.

<br />

## 인터넷 프로토콜, IP

IP주소는 특정 호스트가 아닌 네트워크 인터페이스를 지칭한다.

인터페이스를 여러 개 가지고 있는 장치: 라우터

<br />

### IPv4 데이터그램 포맷

인터넷 네트워크 계층 패킷을 데이터그램이라고 부르며, IPv4 데이터그램 포맷은 다음과 같다.

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/8f34238a-246a-4ffd-8d8a-f3a45a9148ed/17e78fb1-f1d5-4c17-9364-0fb374e72ed3/image.png)

- 버전 번호<br />
  라우터는 버전 번호를 확인하여 데이터그램의 나머지 부분을 어떻게 해석할지 결정한다.

- 헤더 길이<br />
  IPv4 데이터그램 헤더는 20바이트이다.

- 서비스타입<br />
  각기 다른 유형의 IP 데이터그램을 구별한다.
  실시간 데이터그램과 비실시간 트래픽(FTP)을 구분하는데 유용하다.
- 데이터그램 길이<br />
  데이터그램 필드의 길이는 16비트이다.

- 식별자, 플래그, 단편화 오프셋<br />
  IP 단편화와 관련이 있다.
  큰 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할된 다음, 목적지로 독립적으로 전달되며 여기서 페이로드 데이터가 최종 호스트의 트랜스포트 계층으로 전달되기 전에 다시 모이게 된다.
  새로운 IPv6는 단편화를 허용하지 않는다.

- TTL<br />

- 프로토콜<br />
  IP 데이터그램이 최종 목적지에 도착했을 때만 사용된다.
  IP 데이터그램에서 데이터 부분이 전달될 목적지의 트랜스포트 계층의 특정 프로토콜을 명시한다.
  포트 번호가 트랜스포트 계층과 애플리케이션 계층을 함께 묶는 접착제 역할을 하는 것처럼, 프로토콜 번호는 네트워크 계층과 트랜스포트 계층을 묶는 역할을 한다.

- 헤더 체크섬<br />
  헤더 체크섬은 라우터가 수신한 IP 데이터그램의 비트 오류를 탐지하는 데 도움을 준다.
  라우터는 수신한 각 IP 데이터그램마다 헤더 체크섬을 계산하고, 이 값과 데이터그램 헤더의 체크섬이 다르면 오류 상태임을 감지한다.
  라우터는 보통 오류가 검출된 데이터그램을 폐기한다.

- 출발지와 목적지 IP 주소<br />

- 옵션<br />
  IP 헤더를 확장한다.
  모든 데이터그램 헤더 옵션 필드에 정보를 포함하지 않는 방법으로 오버헤드를 해결하기 위해 헤더 옵션은 거의 사용되지 않는다.
  일부 데이터그램은 옵션 처리 유무에 따라서 라우터에서 IP 데이터그램을 처리하는 데 필요한 시간이 크게 달라진다.
  이러한 이유로 IP 옵션은 IPv6에 포함되지 않는다.
- 데이터(페이로드)<br />

<br />

### IPv4 주소체계

호스트는 일반적으로 네트워크와 연결되는 하나의 링크를 갖는다.

호스트 IP가 데이터그램을 보낼 때 이 링크를 통해 데이터그램을 보낸다.

호스트와 물리적 링크 사이의 경계를 인터페이스라고 부른다.

라우터의 작업은 한 링크로부터 데이터그램을 수신하여 다른 링크로 전달하는 것이므로, 라우터는 2개 이상의 연결된 링크가 필요하다.

IPv4의 IP 주소는 32비트(4바이트) 길이다.

모든 호스트와 라우터의 각 인터페이스는 고유한 IP 주소를 갖는다.

이러한 주소는 마음대로 선택할 수 없으며, 인터페이스의 IP 주소 일부는 연결된 서브넷이 결정한다.

호스트들의 인터페이스들과 하나의 라우터 인터페이스로 연결된 네트워크는 서브넷을 구성한다고 말한다.

IP 주소체계는 이 서브넷에 예를 들어 `223.1.1.0/24` 라는 주소를 할당하는데, 여기서 /24는 서브넷 마스크라 부르며 32비트 주소의 왼쪽 24비트가 서브넷 주소, 즉 네트워크 주소라는 것을 의미한다.

위와 같은 주소 형식에서 24와 같이 최상위 비트를 의미하는 값은 IP 주소의 네트워크 부분을 구성하며, 이를 해당 주소의 프리픽스(prefix) 또는 네트워크 프리픽스라고 부른다.

CIDR이 채택되기 전에는 IP 주소의 네트워크 부분을 8, 16, 24 비트로 제한하는 클래스 주소체계로 구성되었다.

그러나 이러한 클래스 주소체계는 IP 주소 할당에 대한 낭비와 부족 문제로 CIDR이 채택된 것이다.

IP 주소의 또 다른 형태인 브로드캐스트 주소는 `255.255.255.255`가 있다.

호스트가 목적지 주소가 `255.255.255.255`인 데이터그램을 보내면, 이 메시지는 같은 서브넷에 있는 모든 호스트에게 전달된다.
