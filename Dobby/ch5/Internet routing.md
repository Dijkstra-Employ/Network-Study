## 인터넷에서의 AS 내부 라우팅: OSPF

엄청나게 많은 라우터들을 안정화시키란 쉽지 않다.

그렇기에 라우터들 사이를 계층적으로 구분하여 분리 관리한다.

<br />

### 자율 시스템, AS

자율 시스템(Autonomous System, AS)는 동일한 관리 제어하에 있는 라우터의 그룹으로 구성된다.

한 ISP의 라우터와 그들을 연결하는 링크가 종종 하나의 AS를 이룬다.

자율 시스템은 전 세계적으로 고유한 AS 번호로 식별된다.

같은 AS 안에 있는 라우터들은 동일한 라우팅 알고리즘을 사용하고 상대방에 대한 정보를 갖고 있다.

자율 시스템 내부에서 동작하는 라우팅 알고리즘을 `AS 내부 라우팅 프로토콜`이라고 한다.

AS들 사이의 포워딩은 돈이나 정책들이 얽혀있다.

AS들 사이는 Peering을 통해 트래픽을 운반해준다.

AS들 사이의 트래픽을 다루는 것은 BGP를 통해서 이루어진다.

<br />

### OSPF

`open shortest path first`

OSPF는 링크 상태 정보를 플러딩하고 다익스트라 최소 비용 경로 알고리즘을 사용하는 링크 상태 알고리즘이다.

OSPF를 이용하여 각 라우터는 전체 AS에 대한 완벽한 토폴로지 지도(그래프)를 얻는다.

OSPF의 자율 시스템(AS)은 계층적인 영역으로 구성될 수 있다.

각 영역은 자신의 OSPF 링크 상태 라우팅 알고리즘을 수행하는데, 한 영역 내의 라우터는 같은 영역 내의 라우터들에게만 링크 상태를 브로드캐스트한다.

각 영역 내에서 하나 혹은 그 이상의 영역 경계 라우터가 영역 외부로의 패킷 라우팅을 책임진다.

AS 내 영역 간 라우팅을 위해서는 먼저 영역 경계 라우터로 패킷을 라우팅하고(영역 내 라우팅), 백본을 통과하여 목적지 영역의 영역 경계 라우터로 라우팅한 후 목적지로 라우팅한다.

<br />

## 인터넷 서비스 제공업자(ISP) 간의 라우팅: BGP

동일한 AS 내에 있는 출발지와 목적지 사이에서 패킷을 라우팅할 때, 패킷이 전송되는 경로는 전적으로 AS 내부 라우팅 프로토콜에 의해 결정된다.

패킷이 여러 AS를 통과하도록 라우팅할 때, 자율 시스템 간 라우팅 프로토콜이 필요하다.

AS 간 라우팅 프로토콜은 여러 AS간의 협력이 수반되므로 통신하는 AS들은 같은 AS 간 라우팅 프로토콜을 수행해야만 한다.

AS 내부에선 최단거리로 이동하지만, AS 간의 이동은 정책적인 부분을 따르며 이동하기 때문에, 최단 거리로 이동하지는 않다.

BGP는 인터넷에 있는 수천 개의 ISP들을 연결하는 프로토콜이므로, 인터넷 프로토콜들 중에서 가장 중요하다고 말할 수 있다.

BGP는 분산형 비동기식 프로토콜이다.

<br />

### BGP의 역할

BGP에서는 패킷이 특정한 목적지 주소를 향해서가 아니라 CIDR 형식으로 표현된, 주소의 앞쪽 프리픽스를 향해 전달된다.

각 프리픽스는 서브넷이나 서브넷의 집합을 의미한다.

1. 이웃 AS를 통해 도달 가능한 서브넷 프리픽스 정보를 얻는다.

   BGP는 각 서브넷이 자신의 존재를 인터넷 전체에 알릴 수 있도록 한다.

2. 서브넷 주소 프리픽스로의 가장 좋은 경로를 결정한다.

<br />

### BGP의 경로 정보 알리기

BGP에서 라우터의 쌍들은 반영구적인 TCP 연결을 통해 라우팅 정보를 교환한다.

이 TCP 연결을 통해 모든 BGP 메시지가 전송되는데, 이 연결을 BGP 연결이라고 부른다.

나아가 2개의 AS를 연결하는 BGP 연결은 외부 BGP(eBGP)연결이라고 하고,

같은 AS 내의 라우터 간 BGP 연결은 내부 BGP(iBGP)연결이라고 한다.

각기 다른 AS에 속하는 게이트웨이 라우터들을 직접 연결하는 링크에는 eBGP 연결이 존재한다.

각 AS 내부 라우터 간에는 iBGP 연결도 존재한다.

도달 가능성 정보를 전파하기 위해서는 iBGP와 eBGP 연결이 모두 사용된다.

<br />

### 뜨거운 감자 라우팅

뜨거운 감자 라우팅은 전체 경로 중에서 자기 AS 외부에서 얼마의 비용이 들지는 신경 쓰지 않고 오로지 자신의 AS 내부 비용만 줄이려는 이기적인 알고리즘이다.

**[ 라우터 포워딩 테이블에 AS 외부의 목적지를 추가하는 과정 ]**

1. 여러 게이트웨이를 통해 서브넷 x에 도달할 수 있다는 사실을 AS간 프로토콜로부터 알게 된다.
2. 각 게이트웨이까지의 최소 비용 경로를 정하기 위해 AS 내부 프로토콜을 통해 얻은 라우팅 정보를 이용한다.
3. 뜨거운 감자 라우팅

   가장 적은 비용의 게이트웨이를 선택한다.

4. 포워딩 테이블로부터 최소 비용 게이트웨이로의 인터페이스 l을 결정한다.

   포워딩 테이블에 (x, l)를 추가한다.
