## 링크 계층, 스위치

스위치는 링크 계층에서 동작하기 때문에 링크 계층 프레임을 교환하고, 네트워크 계층 주소를 인식하지 않으며, 2계층 스위치들로 구성된 네트워크에서 경로를 결정하는 데 OSPF 같은 라우팅 알고리즘을 사용하지 않는다.

스위치 네트워크에서는 링크 계층 프레임을 전달하기 위해 IP 주소가 아닌 링크 계층 주소를 사용한다.

<br />

### MAC

실제로 링크 계층 주소를 가진 것은 호스트나 라우터가 아닌 호스트나 라우터의 어댑터(네트워크 인터페이스)다.

다수의 네트워크 인터페이스를 갖고 있는 호스트나 라우터는 여러 개의 링크 계층 주소를 갖게 된다.

링크 계층 주소는 `MAC 주소`라고도 알려져 있으며, 대부분의 랜의 경우 MAC 주소의 길이는 6바이트이며 따라서 2^48개만큼의 사용 가능한 랜 주소가 있다.

6바이트는 주로 16진수 표기법으로 표시되며, 주소의 각 바이트는 2개의 16진수로 표시된다.

ex) 1A-23-F9-CD-06-9B

어댑터의 MAC 주소는 계층구조가 아닌 평면 구조를 가지며, 어댑터의 위치에 따라 변경되지 않는다.

즉, 이더넷 카드가 있는 휴대용 컴퓨터는 어디에 있든지 항상 동일한 MAC 주소를 갖는다.

이에 반해 IP 주소는 계층 구조를 가지며, 호스트의 IP 주소는 호스트가 다른 네트워크에 접속하면 변경되어야 한다.

어댑터는 자신을 목적지로 하지 않는 프레임을 수신할 수도 있다.

프레임을 수신한 어댑터는 프레임 안의 목적지 MAC 주소가 어댑터 자신의 MAC 주소와 일치하는지 검사한다.

만약 일치하면, 어댑터는 프레임에 포함된 데이터그램을 추출해 그 데이터그램을 프로토콜 스택의 위쪽으로 전달한다.

만약 일치하지 않으면, 어댑터는 네트워크 계층 데이터그램을 프로토콜 스택의 위쪽으로 전달하지 않고 그 프레임을 폐기한다.

따라서 프레임을 수신했을 때 목적지 노드만이 인터럽트된다.

그러나, 어떤 송신 어댑터는 랜상의 다른 모든 어댑터가 자신이 전송한 프레임을 수신하고 처리하기를 원한다.

이 경우엔 송신 어댑터는 프레임의 목적지 주소 필드에 특수한 MAC 브로드캐스트 주소를 넣는다.

(`FF-FF-FF-FF-FF-FF`)

<br />

### ARP

`Address Resolution Protocol`

호스트와 라우터는 링크 계층 주소와 네트워크 계층 주소도 갖는다.

ARP는 이런 네트워크 계층 주소를 링크 계층 주소로 변환해주는 역할을 한다.

송신 호스트가 어떻게 수신 호스트의 IP 주소의 MAC 주소를 결정할 수 있을까?

이는 ARP를 사용함으로써 가능해진다.

송신 호스트의 ARP 모듈은 입력값으로서 동일한 랜상의 임의의 IP 주소에 대해 대응되는 MAC 주소를 돌려준다.

ARP는 호스트 네임을 IP 주소로 해결하는 DNS와 비슷하다.

그러나 이들 변환기의 중요한 차이점은

- DNS가 인터넷의 임의의 장소에 있는 호스트의 호스트 네임을 해결하는 반면에,
- ARP는 동일한 서브넷상에 있는 호스트나 라우터 인터페이스의 IP 주소만을 해결한다.

각 호스트와 라우터는 자신의 메모리에 ARP 테이블을 갖고 있다.

이 ARP 테이블은 IP 주소와 MAC 주소간의 매핑 정보를 포함한다.

또한 각 매핑이 언제 삭제되었는지를 나타내는 TTL 값을 포함한다.

| IP 주소         | MAC 주소          | TTL      |
| --------------- | ----------------- | -------- |
| 222.222.222.221 | 88-B2-2F-54-1A-0F | 13:45:00 |
| 222.222.222.223 | 5C-66-AB-90-75-B1 | 13:52:00 |

[ **ARP 특징** ]

1. 송신 노드는 ARP 패킷이라는 특수 패킷을 구성한다.
2. ARP 패킷은 송신 및 수신 IP 주소와 MAC 주소를 포함하는 필드들을 갖고 있다.
3. ARP 질의 패킷과 응답 패킷 모두 같은 형식을 갖는다.
4. ARP 질의 패킷의 목적은 해결하려는 IP 주소에 대응되는 MAC 주소를 결정하기 위해 서브넷의 다른 모든 호스트와 라우터들에게 질의하는 것이다.

<br />

[ 같은 서브넷에서의 **ARP 과정** ]

1. 송신 호스트는 ARP 질의 패킷을 어댑터에게 전달하며, 이때 어댑터에게 MAC 브로드캐스트 주소, 즉 FF-FF-FF-FF-FF-FF로 패킷을 전송하도록 지시한다.
2. 어댑터는 ARP 패킷을 링크 계층 프레임에 캡슐화하고, 이 프레임의 목적지 주소를 브로드캐스트 주소로 해서 서브넷에 전송한다.
3. 브로드캐스트 주소 때문에 각 어댑터는 프레임에 들어 있는 ARP 패킷을 자신의 ARP 모듈로 전달한다.
4. ARP 모듈은 자신의 IP 주소가 ARP 패킷에 들어 있는 목적지 IP 주소와 일치하는지 검사한다.
5. 일치하는 노드는 요구된 매핑 정보가 포함된 응답 ARP 패킷을 질의한 노드로 돌려보낸다.
6. 그러면 질의 호스트는 자신의 ARP 테이블을 갱신하고 자신의 IP 데이터그램을 링크 계층 프레임으로 캡슐화해서 전송한다.

ARP 패킷은 링크 계층 주소를 포함하는 필드와 네트워크 계층 주소도 포함하기에 ARP는 링크 계층과 네트워크 계층의 경계에 있는 프로토콜이라고 하는 게 가장 타당하다.

<br />

[ 다른 서브넷에서의 ARP ]

서브넷 1에서 서브넷 2로 데이터그램을 전송한다면,

먼저 데이터그램을 라우터 인터페이스로 전달해야 한다.

따라서 이 프레임에 대한 적절한 MAC 주소는 라우터 인터페이스에 대한 어댑터의 주소가 된다.

서브넷 1에 있는 라우터의 어댑터는 링크 계층 프레임이 자신을 목적지로 하는지 검사한 후, 그렇다면 이 프레임을 라우터의 네트워크 계층으로 전달한다.

라우터는 데이터그램이 전달될 정확한 인터페이스를 결정해야 하는데, 이는 라우터의 포워딩 테이블을 참조하여 수행된다.

포워딩 테이블은 라우터에게 데이터그램을 서브넷 2로 연결된 라우터 인터페이스를 거쳐서 전달하도록 지시한다.

그러면 인터페이스는 데이터그램을 자신의 어댑터로 전달하며, 어댑터는 데이터그램을 새 프레임에 캡슐화하여 그 프레임을 서브넷 2로 전송한다.

<br />

### 이더넷

인터넷이 글로벌 네트워킹에 대한 것이라면, 이더넷은 근거리 네트워킹에 대한 것이다.

```
1. FCS (Frame CheckSequence)

  ㅇ프레임의 끝 부분에 수신측의 에러검출을 돕기 위해 삽입하는 필드
     - CRC 에러검출 기법에 의해 생성된 비트 배열이 이에 포함됨

2. FCS 활용

  ㅇ 수신측은 자신이 계산한 FCS와 전송되어온 프레임 내 덧붙인 FCS와 비교하여 에러 여부 확인
     - 에러 확인시에는 해당 프레임을 폐기하고 송신측에 재전송을 요구

3.이더넷LAN 카드의 FCS 처리

  ㅇ이더넷 LAN 카드에서 FCS를 처리함                    ☞이더넷 프레임 참조
     - 그 상위계층에프레임을 넘겨줄 때는 이를 제외하게됨
        . 즉, (MAC 헤더 +데이터) 만 넘김
```

[ **이더넷 프레임 구조** ]

<img src="https://github.com/user-attachments/assets/ed6aea46-623a-4fd3-8a1c-84003e07f27c" width="50%" />

- 데이터 필드:
  이 필드는 IP 데이터그램을 운반한다. 이더넷의 최대 전송 단위(MTU)는 1,500바이트이며, 만일 IP 데이터그램이 1,500바이트를 초과하면 호스트가 이 데이터그램을 단편화해야 한다.
- 목적지 주소
  목적지 어댑터의 MAC 주소를 포함한다.
- 출발지 주소
  프레임을 랜으로 전송하는 어댑터의 MAC 주소를 포함한다.
- 타입 필드
  이더넷으로 하여금 네트워크 계층 프로토콜을 다중화하도록 허용한다.
  IP와 다른 데이터링크 계층 프로토콜들은 자신만의 표준 타입 번호를 갖고 있다.
  즉, 한 계층에서의 프로토콜을 상위 계층의 프로토콜로 연계시키는 역할을 한다.
- 순환 중복 검사(CRC)
  수신 어댑터인 어댑터로 하여금 프레임에 오류가 생겼는지 검출할 수 있게 하는 것이다.

모든 이더넷 기술은 네트워크 계층에서 비연결형 서비스, 네트워크 계층에서 비신뢰적 서비스를 제공한다.

만일, 폐기된 이더넷 프레임 때문에 손실된 데이터그램이 있다면, 호스트의 애플리케이션이 UDP 또는 TCP를 사용하지에 따라 달려있다.

- UDP는 실제로 호스트의 애플리케이션은 손실롤 인해 지장을 받을 것이다.
- TCP는 데이터를 재전송하게 할 것이다.

<br />

## 링크 계층 스위치

스위치의 역할은 링크 계층 프레임을 수신해서 출력 링크로 전달하는 것이다.

호스트/라우트는 프레임을 스위치가 아닌 다른 호스트/라우터를 목적지로 해서 랜상으로 보내며, 중간에 스위치가 프레임을 받아서 다른 노드에게 전달하는 것을 알지 못한다.

또한, 프레임이 스위치 출력 인터페이스들 중 하나에 도착하는 속도가 이 인터페이스의 링크 용량을 일시적으로 초과할 수 있다.

이 문제를 해결하기 위해 라우터 출력 인터페이스가 데이터그램에 대한 버퍼를 갖고 있듯이 스위치 출력 인터페이스도 버퍼를 갖고 있다.

<br />

### 포워딩과 필터링

`필터링`은 프레임을 인터페이스로 전달할지 또는 폐기할지 결정하는 스위치의 기능이다.

`포워딩`은 프레임이 전송될 인터페이스를 결정하고 프레임을 해당 인터페이스로 내보내는 기능이다.

스위치의 필터링과 포워딩은 스위치 테이블을 이용한다.

스위치 테이블에는 랜상의 모든 호스트와 라우터는 아니지만 일부 노드에 대한 엔트리가 포함되어 있다.

스위치 테이블의 엔트리에는

1. MAC 주소
2. 그 MAC 주소로 가게 하는 스위치 인터페이스
3. 해당 엔트리가 테이블에 만들어진 시점에 대한 정보

가 들어있다.

만약 스위치 테이블 엔트리에 목적지 주소에 대한 엔트리가 없으면 스위치는 프레임을 브로드캐스트한다.

<br />

### 자가학습

스위치는 자신의 테이블을 자동으로, 동적으로, 자치적으로 구축하는 놀라운 특징이 있다.

스위치는 자가학습을 하며, 이 능력은 다음과 같이 이루어진다.

1. 스위치 테이블은 초기에 비어있다.
2. 인터페이스로 수신한 각 프레임에 대해 스위치는

   1. 프레임의 출발지 주소 필드에 있는 MAC 주소
   2. 프레임이 도착한 인터페이스
   3. 현재 시간을 테이블에 저장한다.

   이런 식으로 스위치는 테이블에 송신 노드가 상주하는 랜 세그먼트를 기록한다.

3. 일정 시간이 지난 후에도 스위치가 해당 주소를 출발지 주소로 하는 프레임을 수신하지 못하면 테이블에서 이 주소를 삭제한다.

스위치는 네트워크 관리자나 사용자의 개입을 요구하지 않으므로 `플러그 앤 플레이` 장치이다.

<br />

### 링크 계층 스위치의 특성

- 충돌 제거
  - 스위치로 구축된 랜데은 충돌로 인해 낭비되는 대역폭이 없다.
  - 스위치는 프레임을 버퍼링하며 어느 시점이든 세그먼트에 하나 이상의 프레임을 전송하지 않는다.
  - 스위치의 최대 총 처리율은 모든 스위치 인터페이스 속도의 합이다. 따라서 스위치는 브로드캐스트 링크를 사용하는 랜보다 성능이 월등히 향상한다.
- 이질적인 링크들
  - 스위치는 기존 장비를 새로운 장비와 함께 사용할 수 있게 해준다.
- 관리
  - 스위치는 향상된 보안을 제공할 뿐만 아니라 네트워크 관리를 쉽게 할 수 있게 해준다.
  - 어댑터가 오동작해서 이더넷 프레임을 계속 보내는 경우 스위치는 이 문제를 감지하고 오동작하는 어댑터의 연결을 의도적으로 끊는다.

<br />

## VLAN, 가상 근거리 네트워크

VLAN을 지원하는 스위치는 하나의 물리적 근거리 네트워크 인프라스트럭처상에서 여러 개의 가상 근거리 네트워크들을 정의할 수 있게 한다.

VLAN에 속한 호스트들은 마치 스위치에 자신들만 연결된 것처럼 서로 통신한다.

포트 기반 VLAN에서는 네트워크 관리자가 스위치 포트를 그룹으로 나눈다.

<img src="https://github.com/user-attachments/assets/60132244-5300-4f05-b07f-b2c1acfc21dc" width="60%" />

스위치에 연결된 호스트 중에서도 서로 메시지를 주고받을 일이 적거나 브로드캐스트 메시지를 받을 필요가 없어서 굳이 같은 네트워크(LAN)에 속할 필요가 없는 호스트가 있을 수도 있다.

이 경우 VLAN을 구성하면 한 대의 물리적 스위치라 해도 여러 대의 스위치가 있는 것처럼 논리적인 단위로 LAN을 구획할 수 있다.

VLAN 스위치들을 연결하는 좀 더 확장 가능한 방법으로 VLAN 트렁킹이 있다.

VLAN 트렁킹 방법에는 스위치마다 하나의 특수 포트가 2개의 VLAN 스위치를 연결하는 트렁크 포트로 구성된다.

한 VLAN에서 전송한 프레임들을 트렁크 링크를 통해 다른 스위치로 전달해준다.

![image](https://github.com/user-attachments/assets/cc0cbfcc-a5ff-433d-9730-8aadf9c2848e)
